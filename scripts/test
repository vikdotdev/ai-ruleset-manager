#!/bin/sh
set -e

# Test script for AI Ruleset Manager
# Creates tmp directory, runs individual test scripts, then cleans up

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
TEST_DIR="$PROJECT_DIR/test"
TMP_DIR="$TEST_DIR/tmp"


# Test results
TESTS_RUN=0
TESTS_PASSED=0
TESTS_FAILED=0

print_header() {
    echo "========================================"
    echo "AI Ruleset Manager - Test Suite"
    echo "========================================"
    echo ""
}

print_summary() {
    echo ""
    echo "========================================"
    echo "Test Summary"
    echo "========================================"
    echo "Tests run: $TESTS_RUN"
    echo "Passed: $TESTS_PASSED"
    echo "Failed: $TESTS_FAILED"
    echo ""

    if [ $TESTS_FAILED -eq 0 ]; then
        echo "All tests passed!"
        exit 0
    else
        echo "Some tests failed."
        exit 1
    fi
}

# Cleanup function
cleanup() {
    if [ -d "$TMP_DIR" ]; then
        rm -rf "$TMP_DIR"
    fi
}

# Trap cleanup on exit
trap cleanup EXIT

# Main test execution
main() {
    local specific_test="$1"

    print_header

    # Create tmp directory
    mkdir -p "$TMP_DIR"

    if [ -n "$specific_test" ]; then
        # Run specific test
        test_script="$TEST_DIR/$specific_test"
        if [ ! -f "$test_script" ]; then
            test_script="$TEST_DIR/$specific_test.sh"
        fi

        if [ -f "$test_script" ] && [ -x "$test_script" ]; then
            test_name=$(basename "$test_script" .sh)
            echo "Running: $test_name"

            TESTS_RUN=$((TESTS_RUN + 1))

            if "$test_script"; then
                TESTS_PASSED=$((TESTS_PASSED + 1))
            else
                TESTS_FAILED=$((TESTS_FAILED + 1))
            fi
            echo ""
        else
            echo "Test not found: $specific_test"
            echo "Available tests:"
            for script in "$TEST_DIR"/*.sh; do
                if [ -f "$script" ]; then
                    echo "  $(basename "$script" .sh)"
                fi
            done
            exit 1
        fi
    else
        # Run all test scripts
        for test_script in "$TEST_DIR"/*.sh; do
            if [ -f "$test_script" ] && [ -x "$test_script" ]; then
                test_name=$(basename "$test_script" .sh)
                echo "Running: $test_name"

                TESTS_RUN=$((TESTS_RUN + 1))

                if "$test_script"; then
                    TESTS_PASSED=$((TESTS_PASSED + 1))
                else
                    TESTS_FAILED=$((TESTS_FAILED + 1))
                fi
                echo ""
            fi
        done
    fi

    # Print summary
    print_summary
}

# Run main function
main "$@"